<script>
function getParam(k){
  const m = new URLSearchParams(location.search).get(k);
  return (m || '').trim();
}

let studentCode = getParam('code') || (localStorage.getItem('falowen_code') || '').trim();

function ensureCodeBeforeUse() {
  const gate = document.getElementById('code-gate');
  const main = document.getElementById('app');
  if (!studentCode) {
    gate.style.display = 'block';
    main.style.display = 'none';
  } else {
    gate.style.display = 'none';
    main.style.display = 'block';
  }
}

function saveCode() {
  const inp = document.getElementById('code-input');
  const v = (inp.value || '').trim().toLowerCase();
  if (!v) { alert('Please enter your student code.'); return; }
  studentCode = v;
  localStorage.setItem('falowen_code', v);
  ensureCodeBeforeUse();
}

// Call once on load
document.addEventListener('DOMContentLoaded', ensureCodeBeforeUse);

// When you POST the audio, ALWAYS include the code:
async function uploadBlob(blob) {
  if (!studentCode) { alert('Missing student code.'); return; }

  const fd = new FormData();
  fd.append('audio', blob, 'recording.webm');
  fd.append('code', studentCode); // <— important

  // example endpoint; keep yours as-is
  const r = await fetch('/api/upload', { method: 'POST', body: fd });
  if (!r.ok) { alert('Upload failed.'); return; }
  const js = await r.json().catch(()=>({}));
  // show result/redirect/etc.
}
</script>

<!-- Add this small gate UI somewhere near the top of <body> -->
<div id="code-gate" style="display:none; max-width:680px; margin:16px auto; padding:12px; border:1px solid #e5e7eb; border-radius:10px;">
  <h3 style="margin:0 0 8px 0;">Enter your student code</h3>
  <p style="margin:0 0 8px 0;">We couldn’t find <code>?code=...</code> in the link. Please enter it once to continue.</p>
  <input id="code-input" placeholder="e.g., felixa1" style="padding:8px; width:260px;">
  <button onclick="saveCode()" style="padding:8px 12px; margin-left:8px;">Save</button>
</div>

<!-- Wrap your main recorder UI so we can hide/show -->
<div id="app" style="display:none;">
  <!-- your existing recorder controls go here -->
</div>
