<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Falowen ‚Äî Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f8fb;--fg:#0f172a;--card:#fff;--muted:#64748b;--accent:#2563eb;--accent2:#0ea5e9;--okbg:#ecfdf5;--okfg:#065f46;--errbg:#fef2f2;--errfg:#991b1b;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    .wrap{max-width:820px;margin:18px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 16px 20px 16px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    h1{font-size:20px;margin:0 0 8px}
    label{font-weight:600;font-size:14px}
    input[type=text], textarea{width:100%;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:15px}
    textarea{min-height:84px}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn{background:var(--accent);color:#fff}
    .btn-secondary{background:var(--accent2);color:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .row > *{flex:1 1 220px}
    .muted{color:var(--muted);font-size:13px;margin-top:6px}
    .err{background:var(--errbg);color:var(--errfg);border:1px solid #fecaca;border-radius:10px;padding:10px;margin-top:10px}
    .ok {background:var(--okbg);color:var(--okfg);border:1px solid #a7f3d0;border-radius:10px;padding:10px;margin-top:10px}
    .info{background:#eef2ff;color:#1e1b4b;border:1px solid #c7d2fe;border-radius:10px;padding:10px;margin-top:10px}
    audio{width:100%;margin-top:10px}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid #cbd5e1;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;vertical-align:-2px}
    @keyframes spin{to{transform:rotate(360deg)}}
    pre{white-space:pre-wrap;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üéôÔ∏è Falowen ‚Äî Voice Recorder</h1>
      <p class="muted">Record your speaking sample here. Upload will include your student code. Then we‚Äôll generate AI feedback right on this page.</p>

      <div id="apiStatus" class="info">Checking backend‚Ä¶ <span class="spinner"></span></div>

      <div class="row">
        <div>
          <label for="code">Student Code</label>
          <input id="code" type="text" placeholder="e.g., felixa1" />
          <div class="muted">If you came from the app, this may be prefilled.</div>
        </div>
        <div style="align-self:flex-end">
          <button class="btn-secondary" id="saveCodeBtn">Save Code</button>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <div>
          <button class="btn" id="recBtn">Start Recording</button>
        </div>
        <div>
          <button class="btn-secondary" id="uploadBtn" disabled>Upload</button>
        </div>
      </div>

      <audio id="player" controls></audio>

      <div id="msg"></div>

      <hr style="margin:18px 0;border:none;border-top:1px solid var(--border)"/>

      <h2 style="font-size:16px;margin:0 0 8px">üß† AI Feedback</h2>
      <p class="muted">After upload, we‚Äôll auto‚Äërequest feedback. You can also paste a typed answer and check instantly.</p>

      <div class="row">
        <div>
          <label for="typed">Typed answer (optional)</label>
          <textarea id="typed" placeholder="Ich bin Felix. Ich komme aus Ghana."></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <button class="btn" id="checkTypedBtn">Get Feedback for Typed Answer</button>
        </div>
        <div>
          <button class="btn-secondary" id="recheckAudioBtn" disabled>Re-run Feedback on Last Upload</button>
        </div>
      </div>

      <div id="fb"></div>

      <p class="muted" style="margin-top:10px">
        Tips: Use Chrome on Android. If the mic prompt doesn‚Äôt show, check Site Settings ‚Üí Microphone.
      </p>
    </div>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const api = {
      health: "/api/health",
      upload: "/api/upload",
      feedback: "/api/feedback",
    };

    function setMsg(html, cls){ const m=$("msg"); m.className = cls || ''; m.innerHTML = html || ''; }
    function setFb(html){ const el=$("fb"); el.innerHTML = html || ''; }
    function esc(s){ return String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }

    // ---------- API health check ----------
    (async function checkHealth(){
      const el=$("apiStatus");
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), 4500);
        const r = await fetch(api.health, { signal: ctrl.signal });
        clearTimeout(t);
        if(r.ok){ el.className='ok'; el.textContent='Backend OK'; }
        else { el.className='err'; el.textContent='Backend not reachable ('+r.status+').'; }
      }catch(e){ el.className='err'; el.textContent='Backend not reachable'; }
    })();

    // ---------- student code ----------
    const codeInput = $("code");
    const saveBtn   = $("saveCodeBtn");
    const params    = new URLSearchParams(location.search);

    (function initCode(){
      const fromQS = (params.get('code') || '').trim().toLowerCase().replace(/\s+/g,'');
      const fromLS = (localStorage.getItem('falowen_code') || '').trim();
      if (fromQS) {
        codeInput.value = fromQS;
        localStorage.setItem('falowen_code', fromQS);
      } else if (fromLS) {
        codeInput.value = fromLS;
      }
    })();

    saveBtn.onclick = () => {
      const v = (codeInput.value || '').trim().toLowerCase().replace(/\s+/g,'');
      if (!v) return setMsg('Please enter a valid student code.', 'err');
      localStorage.setItem('falowen_code', v);
      setMsg('Saved ‚úîÔ∏è Next time this will be prefilled.', 'ok');
    };

    // ---------- recording ----------
    const recBtn    = $("recBtn");
    const uploadBtn = $("uploadBtn");
    const recheckBtn= $("recheckAudioBtn");
    const player    = $("player");

    let mediaRecorder = null;
    let chunks = [];
    let blob = null;
    let lastStoragePath = null; // for re-run feedback

    recBtn.onclick = async () => {
      setMsg('', '');
      setFb('');
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        // start
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          chunks = [];
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
          mediaRecorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = () => {
            blob = new Blob(chunks, { type: 'audio/webm' });
            player.src = URL.createObjectURL(blob);
            uploadBtn.disabled = false;
          };
          mediaRecorder.start();
          recBtn.textContent = 'Stop Recording';
          uploadBtn.disabled = true;
          setMsg('Recording‚Ä¶ speak now. Click ‚ÄúStop Recording‚Äù when done (max ~60s).', 'muted');
          setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
              mediaRecorder.stop();
              recBtn.textContent = 'Start Recording';
              setMsg('Stopped automatically at 60s.', 'ok');
            }
          }, 60000);
        } catch (e) {
          setMsg('Microphone error: ' + e.message, 'err');
        }
      } else {
        // stop
        mediaRecorder.stop();
        recBtn.textContent = 'Start Recording';
        setMsg('Recording stopped. You can play it back or upload.', 'ok');
      }
    };

    // ---------- upload & feedback ----------
    uploadBtn.onclick = async () => {
      setMsg('', '');
      setFb('');
      const code = (codeInput.value || localStorage.getItem('falowen_code') || '').trim().toLowerCase().replace(/\s+/g,'');
      if (!code) return setMsg('Please enter your student code and click ‚ÄúSave Code‚Äù first.', 'err');
      if (!blob)  return setMsg('No recording found. Please record first.', 'err');

      const form = new FormData();
      form.append('code', code);
      form.append('file', blob, `speech_${Date.now()}.webm`);

      try {
        setMsg('Uploading‚Ä¶ <span class="spinner"></span>', 'info');
        const res = await fetch(api.upload, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Upload failed: HTTP ' + res.status);
        const j = await res.json().catch(()=> ({}));
        lastStoragePath = j.path || null;
        setMsg('Upload complete ‚úîÔ∏è Generating AI feedback‚Ä¶ <span class="spinner"></span>', 'ok');
        recheckBtn.disabled = !lastStoragePath;
        if (lastStoragePath) {
          await getFeedback({ mode: 'audio', storagePath: lastStoragePath, code });
        } else {
          setMsg('Upload succeeded but no storage path returned.', 'err');
        }
      } catch (e) {
        setMsg('Upload error: ' + esc(e.message) + '<br/>Backend not deployed? Ensure /api/upload exists.', 'err');
      }
    };

    async function getFeedback({ mode, storagePath, code, text }){
      try{
        setFb('<div class="info">Requesting feedback‚Ä¶ <span class="spinner"></span></div>');
        const body = mode === 'text' ? { mode:'text', text, code } : { mode:'audio', storagePath, code };
        const r = await fetch(api.feedback, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!r.ok || !data.ok) {
          throw new Error((data && data.error) || ('HTTP '+r.status));
        }
        const parts = [];
        parts.push('<div class="ok"><b>Transcript:</b> ' + esc(data.transcript || '(none)') + '</div>');
        parts.push('<div class="ok"><b>Score:</b> ' + esc(data.score) + '/10</div>');
        parts.push('<div class="ok"><b>Feedback:</b><br/><pre>'+esc(data.feedback || '')+'</pre></div>');
        setFb(parts.join('\n'));
        setMsg('Done ‚úîÔ∏è', 'ok');
      }catch(e){
        setFb('<div class="err">Feedback error: '+esc(e.message)+'<br/>If you see "OPENAI_API_KEY not set", create the Functions secret and redeploy.</div>');
      }
    }

    // typed feedback button
    $("checkTypedBtn").onclick = async () => {
      const text = ($("typed").value || '').trim();
      if (!text) return setMsg('Type an answer first.', 'err');
      const code = (codeInput.value || localStorage.getItem('falowen_code') || '').trim().toLowerCase().replace(/\s+/g,'');
      await getFeedback({ mode:'text', text, code });
    };

    // re-run feedback on last uploaded audio
    recheckBtn.onclick = async () => {
      if (!lastStoragePath) return setMsg('No previous upload found.', 'err');
      const code = (codeInput.value || localStorage.getItem('falowen_code') || '').trim().toLowerCase().replace(/\s+/g,'');
      await getFeedback({ mode:'audio', storagePath: lastStoragePath, code });
    };
  </script>
</body>
</html>
